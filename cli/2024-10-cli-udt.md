# Topic: CLI commands for User-Defined-Type definitions

* **Author**: Reshma Abdul Rahim (reshrahim)

## Topic Summary
<!-- A paragraph or two to summarize the topic area. Just define it in summary form so we all know what it is. -->
User-Defined Types enable Platform engineers to define and deploy their organization's custom services in Radius. More details around the feature, user scenarios and experience can be found [here](/architecture/2024-06-resource-extensibility-feature-spec.md). This document will focus on the CLI experience for creating and operating the User-Defined -Resource-Type definitions.

### Top level goals
<!-- At the most basic level, what are we trying to accomplish? -->
- Provide an intuitive and seamless experience for platform engineers to create, update, and delete User-Defined-Type definitions using the CLI.
- Ensure that the CLI experience is consistent with the other commands in Radius

### Non-goals (out of scope)
<!-- What are we explicitly not trying to accomplish? -->
- Other interfaces and experiences to interact with user defined resource type definitions and resources are out of scope for this document

## Key scenarios
<!-- List ~3-7 high level scenarios to clarify the value and point to how we will decompose this big area into component capabilities. We may ultimately have more than one level of scenario. -->
The key scenarios for UDTs are outlined [here](/architecture/2024-06-resource-extensibility-feature-spec.md). We will decompose these scenarios specific to the CLI experience.

### Scenario 1: Deb defines and deploys the internal messaging service using the CLI
<!-- One or two sentence summary -->
Deb, a platform engineer who wants to define and deploy their internal messaging service Plaid as a resource type in Radius. 

Before we start designing the experience, we need to understand the high level terminologies/concept that a user would interact with in the CLI experience.

| Terminology | Description | Example | 
|-------------|-------------|---------|
|Resource provider | Refers to a group of resource types under a common namespace. Resource providers are also entities that implement the group of resource types | Mycompany.Messaging or Applications.Core |
|Resource type | A service or technology that can be modeled as a resource | PostgreSQL or AWS S3 or Internal messaging service |
|Resource | An instance of a resource type | mydb or mybucket |

#### User Experience
Below is an illustrative example of how Deb would define the internal messaging service Plaid as a resource type in Radius. 

1. Deb creates the resource provider and the resource type with Radius

    ```bash
    rad resource-provider create -f Mycompany.Messaging.yaml
    ```
    `Mycompany.Messaging.yaml` is the schema definition file that contains the resource type definition for the messaging service Plaid. See the feature spec that covers the [authoring experience for the schema definition](https://github.com/radius-project/design-notes/blob/67dd03056d22bcae2ee9743ffb308c8ac7f012bd/architecture/2024-10-user-defined-types-authoring-experience-feature-spec.md)

2. Deb creates the resource instance for the messaging service Plaid

    ```bash
    rad resource create Mycompany.Messaging/Plaid myplaid -f myplaid.json
    ```
    The resource `myplaid` of type `Mycompany.Messaging/plaidResource`is created and available for use.

4. Deb lists the resource providers and resource types available in Radius

    ```bash
    rad resource-provider list
    ```
    The list of resource providers are displayed.

    ```bash
    rad resource-type list --resource-provider Mycompany.Messaging
    ```
    The list of resource types under the resource provider `Mycompany.Messaging` are displayed.

5. Deb makes changes to the resource type definition of `plaidResource` and adds to the resource provider

    ```bash
    rad resource-provider create -f Mycompany.Messaging.yaml
    ```

6. Deb wants to know the details of resource provider

    ```bash
    rad resource-provider show Mycompany.Messaging
    ```
    The details of the resource provider `Mycompany.Messaging` are displayed.

7. Deb deletes a resource-type Plaid from the resource provider Mycompany.Messaging

    ```bash
    rad resource-type delete Mycompany.Messaging/plaidResource
    Warning: `myapp` application has resources of type `Mycompany.Messaging/plaidResource` provisioned and running. Are you sure you want to delete the resource type plaidResource from the resource provider Mycompany.Messaging? (yes/no)
    ```
    The resource type `Plaid` is deleted from the resource provider `Mycompany.Messaging`

8. Deb deletes the resource provider Mycompany.Messaging

    ```bash
    rad resource-provider delete Mycompany.Messaging
    Warning: `myapp` application has resources of type `Mycompany.Messaging/plaidResource` provisioned and running. Are you sure you want to delete the resource provider Mycompany.Messaging? (yes/no)
    ```

## Finalized set of commands

### rad resource-provider

#### 1. rad resource-provider create

Resource providers are entities that implement a group of resource types such as `Applications.Core`. Creating a resource provider involves creating new resource types that can be used in your applications. Inputs can be passed in as a file or as flags.

1. Create a resource provider from a file 
    
    ```bash
    rad resource-provider create -f Mycompany.Messaging.yaml
    Resource provider Mycompany.Messaging created successfully
    ```

2. Create a resource provider with flags

    ```bash
    rad resource-provider create --name Mycompany.Messaging 
    Resource provider Mycompany.Messaging created successfully
    ```

**Flags**
- `-f`, `--from-file` : File path to the schema definition file
- `-n`, `--name` : Name of the resource provider

Question:
- Should there be a flag that indicates the tenant to which the resource provider is created? Might be needed for multi

#### 2. rad resource-provider list
Resource providers are entities that implement a group of resource types such as `Applications.Core`. Users can list all the resource providers available in your tenant.

    ```bash
    rad resource-provider list 
    RESOURCE-PROVIDER   TYPE                                STATE
    Mycompany.Messaging System.Resources/resourceProviders  Succeeded
    ```

#### 3. rad resource-provider show
Resource providers are entities that implement a group of resource types such as `Applications.Core`. User can display the details of the resource providers.

    ```bash
    rad resource-provider show Mycompany.Messaging
    RESOURCE-PROVIDER   TYPE                                STATE
    Mycompany.Messaging System.Resources/resourceProviders  Succeeded
    ```

#### 4. rad resource-provider delete
Resource providers are entities that implement a group of resource types such as `Applications.Core`. Users can delete a resource provider.

    ```bash
    rad resource-provider delete Mycompany.Messaging
    ```
**Behaviors**
Option 1 : Radius can prompt the user with a warning message if there are resources provisioned and running under the resource provider. If the user confirms deletion, Radius cleans up everything, deletes resources, types and resource providers.

Option 2 : Radius can error out if there are resources provisioned and running under the resource provider. The user needs to delete the resources before deleting the resource provider.

### rad resource-type

#### 1. rad resource-type create
Resource types are the entities that implement resource types such as 'Applications.Core/containers'. Each resource type can define multiple API versions, and each API version defines a schema that resource instances conform to. Inputs can be passed in as a file or as flags.

1. Create a resource type from a file 
    
    ```bash
    rad resource-type create -f plaid.yaml
    ```

2. Create a resource type from flags

    ```bash
    rad resource-type create --resource-provider Mycompany.Messaging --resource-type plaidResource --version=2024-10-09 --properties host=string port=string
    ```

**Flags**
- `-f`, `--from-file` : File path to the schema definition file
- `-rp`, `--resource-provider` : Name of the resource provider
- `-rt`, `--resource-type` : Name of the resource type
- `-p`, `--properties` : Properties of the resource type
- `-v`, `--version` : Version of the resource type

#### 2. rad resource-type list
Resource types are the entities that implement resource types such as 'Applications.Core/containers'. Users can list all the resource types available in the resource provider.

    ```bash
    rad resource-type list --resource-provider Mycompany.Messaging
    RESOURCE-TYPE   TYPE   STATE
    plaidResource   Mycompany.Messaging Succeeded
    resourceType2   Mycompany.Messaging Succeeded
    ```

#### 3. rad resource-type show
Resource types are the entities that implement resource types such as 'Applications.Core/containers'. Users can display the details of the resource types.

    ```bash
    rad resource-type show Mycompany.Messaging/plaidResource
    RESOURCE-TYPE   TYPE   STATE
    plaidResource   Mycompany.Messaging Succeeded
    ```

#### 4. rad resource-type delete
Resource types are the entities that implement resource types such as 'Applications.Core/containers'. Users can delete a resource type.

    ```bash
    rad resource-type delete Mycompany.Messaging/plaidResource
    ```
Behaviors
Option 1 : Radius can prompt the user with a warning message if there are resources provisioned and running under the resource type. If the user confirms deletion, Radius cleans up everything, deletes resources, types and resource providers.

Option 2 : Radius can error out if there are resources provisioned and running under the resource type. The user needs to delete the resources before deleting the resource type.

## Commands to consider for future iterations

1. Deb uses the rad CLI to scaffold a `yaml` template definition for the internal messaging service `Plaid`

    ```bash
    rad resource-provider init Mycompany.Messaging --schema-format yaml
    ```
        
This command will create a folder with the name `Mycompany.Messaging`. A sample `yaml` file is created in the application folder. If we enable typespec, a sample `tsp` will be created and all the required dependencies will be created.

## Key investments
<!-- List the features required to enable this scenario(s). -->

### Feature 1
<!-- One or two sentence summary -->

### Feature 2
<!-- One or two sentence summary -->

### Feature 3
<!-- One or two sentence summary -->
